<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Enable Earth Demo Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    :root { --primary:#024a18; --secondary:#E8F4E5; --accent:#336633; }
    body { margin: 0; font-family: Arial, sans-serif; background: var(--secondary);}
    header { background: var(--primary); padding: 10px; text-align: center; }
    header img { height: 50px; }
    #controls { background: var(--primary); padding: 10px; text-align: center;}
    #controls button { margin: 0 5px; padding: 8px 12px; background: var(--accent); color: #fff; border: none; border-radius: 4px; cursor: pointer;}
    #controls button:hover { background: #295427;}
    #map { height: 60vh;}
    #history { padding: 10px; background: #fff; border-top: 1px solid #ccc;}
    #history h3 { margin-top: 0; color: var(--primary);}
    .cluster-carbon{font-weight:bold;color:#024a18;}
    #monitoring video { width: 90%; max-width: 600px; margin: 10px auto; display: block; border-radius: 12px;}
  </style>
</head>
<body>
  <header>
    <a href="https://enableearth.eco" target="_blank"><img src="public/logo.jpg" alt="Enable Earth logo"></a>
  </header>
  <div id="controls">
    <button id="btn-routing">Routing</button>
  </div>
  <div id="map"></div>
  <div id="history"><p>คลิก Routing เพื่อเริ่มคำนวณ</p></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
  let map, markerCluster, data;
  let lines = [], hubMarkers = [], mainRoadMarkers = [];

  function initMap() {
    map = L.map('map').setView([19.2, 99.56], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
    fetch('public/call.geojson')
      .then(r => r.json())
      .then(json => {
        data = json;
        plotPoints();
      });
    document.getElementById('btn-routing').onclick = calcRoutingFull;
  }

  function plotPoints() {
    if(markerCluster) map.removeLayer(markerCluster);
    markerCluster = L.markerClusterGroup();
    L.geoJSON(data, {
      pointToLayer: (f, latlng) => L.marker(latlng),
      onEachFeature: (f, lyr) => lyr.bindPopup(`<strong>${f.properties.plot_id}</strong>`)
    }).addTo(markerCluster);
    markerCluster.addTo(map);
    if(data.features.length) map.fitBounds(markerCluster.getBounds());
  }

  // --- Cluster Utility ---
  function dbscanCluster(features, epsKm) {
    // Simple DBSCAN-like for low point count
    let assigned = Array(features.length).fill(false);
    let clusters = [];
    for (let i = 0; i < features.length; i++) {
      if (assigned[i]) continue;
      let cluster = [features[i]];
      assigned[i] = true;
      for (let j = 0; j < features.length; j++) {
        if (assigned[j]) continue;
        let d = turf.distance(
          turf.point(features[i].geometry.coordinates),
          turf.point(features[j].geometry.coordinates),
          {units:'kilometers'}
        );
        if (d <= epsKm) { cluster.push(features[j]); assigned[j] = true; }
      }
      clusters.push(cluster);
    }
    return clusters;
  }

  // --- Routing Main ---
  async function calcRoutingFull() {
    clearAllLines();

    const plots = data.features;
    if (plots.length < 2) return alert("ต้องมี plot อย่างน้อย 2 จุด");

    // 1. Cluster (รัศมี 2 km)
    const bigClusters = dbscanCluster(plots, 2);

    // 2. Hub Station ในแต่ละ Cluster (mini-cluster 1km)
    let allHubs = [];
    bigClusters.forEach((cluster, cidx) => {
      let mini = dbscanCluster(cluster, 1);
      mini.forEach(group => {
        // centroid = hub
        const fc = turf.featureCollection(group.map(f=>turf.point(f.geometry.coordinates)));
        const centroid = turf.centroid(fc);
        allHubs.push({cluster: cidx+1, lat: centroid.geometry.coordinates[1], lng: centroid.geometry.coordinates[0], plots: group});
      });
    });

    // 3. หา main road (ถนน) ใกล้ Hub Station แต่ละ hub
    // ใช้ OSRM nearest service หรือ random point offset
    for(let i=0;i<allHubs.length;i++){
      const hub = allHubs[i];
      // nearest road
      let roadCoords = null, roadDist = 0;
      try {
        const url = `https://router.project-osrm.org/nearest/v1/driving/${hub.lng},${hub.lat}`;
        const res = await fetch(url);
        const json = await res.json();
        if(json.code==="Ok" && json.waypoints && json.waypoints.length>0) {
          roadCoords = json.waypoints[0].location; // [lng,lat]
          roadDist = turf.distance(turf.point([hub.lng, hub.lat]), turf.point(roadCoords), {units:'kilometers'});
        }
      } catch(e){}
      if(!roadCoords){
        // fallback: 500 m เหนือ centroid
        const p = turf.destination(turf.point([hub.lng, hub.lat]), 0.5, 0, {units:'kilometers'});
        roadCoords = p.geometry.coordinates;
        roadDist = 0.5;
      }
      // วาด main road marker
      const mainMarker = L.marker([roadCoords[1], roadCoords[0]], {
        icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/854/854894.png',iconSize:[22,22]})
      }).addTo(map)
      .bindPopup(`Main Road<br>Hub#${i+1}<br>ระยะทาง: ${roadDist.toFixed(2)} กม.`);
      mainRoadMarkers.push(mainMarker);
      // 4. วาดเส้นทาง main road → hub (routing จริง, fallback เส้นตรง)
      let geo = [[roadCoords[1],roadCoords[0]],[hub.lat,hub.lng]], dist = roadDist, isRoute = false;
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${roadCoords[0]},${roadCoords[1]};${hub.lng},${hub.lat}?overview=full&geometries=geojson`;
        const res = await fetch(url);
        const json = await res.json();
        if(json.code==="Ok" && json.routes && json.routes.length>0){
          dist = json.routes[0].distance/1000;
          geo = json.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
          isRoute = true;
        }
      }catch(e){}
      const line = L.polyline(geo, {color: "#07bd5c", weight: 4, dashArray:'8,6'})
        .addTo(map).bindPopup(`Main Road → Hub#${i+1}<br>ระยะทาง: ${dist.toFixed(2)} กม.${isRoute?"":" (เส้นตรง)"}`);
      lines.push(line);
      allHubs[i].mainroadDist = dist;
      allHubs[i].mainroadGeo = geo;
    }

    // 5. วาดเส้นตรง Hub ↔ Hub ต่อกัน (hub1→hub2→...)
    let totalHubDist = 0;
    for(let i=0; i<allHubs.length-1; i++) {
      const a = allHubs[i], b = allHubs[i+1];
      const d = turf.distance(
        turf.point([a.lng, a.lat]),
        turf.point([b.lng, b.lat]), {units:'kilometers'});
      const line = L.polyline([[a.lat, a.lng], [b.lat, b.lng]], {color:'#ff6600', weight:3, dashArray:'5,6'})
        .addTo(map).bindPopup(`Hub#${i+1} → Hub#${i+2}<br>ระยะทาง: ${d.toFixed(2)} กม.`);
      lines.push(line);
      totalHubDist += d;
    }

    // 6. วาดเส้นตรง Hub → Plot ของ Hub (สมาชิกของแต่ละ Hub)
    let totalPlotDist = 0;
    allHubs.forEach((hub, hidx) => {
      const hubLatLng = [hub.lat, hub.lng];
      const marker = L.marker(hubLatLng, {icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [28,28]
      })}).addTo(map).bindPopup(`Hub#${hidx+1}<br>Cluster: ${hub.cluster}`);
      hubMarkers.push(marker);
      hub.plots.forEach(plot => {
        const plotLatLng = [plot.geometry.coordinates[1], plot.geometry.coordinates[0]];
        const d = turf.distance(turf.point([hub.lng, hub.lat]), turf.point(plot.geometry.coordinates), {units:'kilometers'});
        const line = L.polyline([hubLatLng, plotLatLng], {color:'#e06a00', weight:2, dashArray:'2,7'})
          .addTo(map)
          .bindPopup(`Hub#${hidx+1} → ${plot.properties.plot_id}<br>ระยะทาง: ${d.toFixed(2)} กม.`);
        lines.push(line);
        totalPlotDist += d;
      });
    });

    // 7. รวมระยะทางทั้งหมด
    const totalMainroadDist = allHubs.reduce((s,h)=>s+(h.mainroadDist||0), 0);
    const totalAll = totalMainroadDist + totalHubDist + totalPlotDist;

    // Summary
    let summaryHtml = `<h3>Routing Summary</h3>
      <ul>
        <li>Cluster (≤2km): <b>${bigClusters.length}</b></li>
        <li>Hub Station (≤1km): <b>${allHubs.length}</b></li>
        <li>รวมระยะทาง Main road → Hub: <b>${totalMainroadDist.toFixed(2)}</b> กม.</li>
        <li>รวมระยะทาง Hub ↔ Hub: <b>${totalHubDist.toFixed(2)}</b> กม.</li>
        <li>รวมระยะทาง Hub → Plot: <b>${totalPlotDist.toFixed(2)}</b> กม.</li>
        <li><b>รวมระยะทางทั้งหมด: ${totalAll.toFixed(2)} กม.</b></li>
      </ul>
      <span style='font-size:12px;color:#888;'>คลิกแต่ละเส้นทางเพื่อดูระยะ</span>`;
    document.getElementById('history').innerHTML = summaryHtml;

    // Fit map
    if (allHubs.length) map.fitBounds(L.latLngBounds(allHubs.map(h=>[h.lat,h.lng])));
  }

  function clearAllLines() {
    lines.forEach(l => map.removeLayer(l)); lines = [];
    hubMarkers.forEach(m=>map.removeLayer(m)); hubMarkers = [];
    mainRoadMarkers.forEach(m=>map.removeLayer(m)); mainRoadMarkers = [];
  }

  document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
