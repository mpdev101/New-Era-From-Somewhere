<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Enable Earth - ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kanit:400,700&display=swap">
  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* ... (‡∏Ñ‡∏á style ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ... */
    /* ‡πÉ‡∏™‡πà style ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô */
    #map { width:100%; height: 250px; border-radius: 10px; margin: 12px 0;}
    .leaflet-control-attribution {display:none}
  </style>
</head>
<body>
<header>
  <img src="public/logo.jpg" class="logo" alt="Enable Logo" onclick="window.open('https://enableearth.eco/', '_blank')"/>
  <div class="title">Enable Earth</div>
  <div class="subtitle">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏ã‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î</div>
</header>
<div class="progress-bar-bg">
  <div id="progress-bar" class="progress-bar" style="width:25%"></div>
</div>
<div class="form-container">
  <!-- Step 1 -->
  <div class="form-step active" id="step1">
    <div class="step-header">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
    <div class="input-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
      <input type="text" id="fullname" required>
    </div>
    <div class="input-group">
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
      <input type="tel" id="tel" pattern="[0-9]{9,10}" maxlength="10" required>
    </div>
    <div class="step-btn-row">
      <div></div>
      <button class="btn" onclick="gotoStep(2)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </div>
  <!-- Step 2 -->
  <div class="form-step" id="step2">
    <div class="step-header">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£</div>
    <div class="input-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏£‡πà</label>
      <input type="number" min="0.1" step="0.1" id="farm_area" required>
    </div>
    <div class="input-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ (‡∏ï‡∏±‡∏ô)</label>
      <input type="number" min="0" step="0.01" id="carbon_credit" required>
    </div>
    <div class="input-group">
      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
      <textarea id="farm_detail" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö"></textarea>
    </div>
    <div class="step-btn-row">
      <button class="btn btn-outline" onclick="gotoStep(1)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <button class="btn" onclick="gotoStep(3)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </div>
  <!-- Step 3 -->
  <div class="form-step" id="step3">
    <div class="step-header">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</div>
    <div class="location-box" id="locationBox">
      <div class="location-icon">üìç</div>
      <div id="location-status">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</div>
      <div id="location-coord"></div>
      <div id="map"></div>
      <button class="btn" onclick="setCurrentLocation(event)">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
      <div style="font-size:.92em; color:#757;">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô marker ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
    </div>
    <div class="step-btn-row">
      <button class="btn btn-outline" onclick="gotoStep(2)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <button class="btn" onclick="gotoStep(4)" id="btn-step3-next" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </div>
  <!-- Step 4 -->
  <div class="form-step" id="step4">
    <div class="step-header">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏∑‡∏ä‡∏ú‡∏•</div>
    <div class="camera-box">
      <div class="camera-icon">üì∑</div>
      <div id="camera-status">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ã‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡πÉ‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î</div>
      <input type="file" id="image" accept="image/*" capture="environment" style="margin-top:10px;">
    </div>
    <div class="step-btn-row">
      <button class="btn btn-outline" onclick="gotoStep(3)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <button class="btn" onclick="submitForm(event)">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>
</div>
<div class="contact-box">
  <img src="public/logo.jpg" class="footer-logo" onclick="window.open('https://enableearth.eco/','_blank')"/><br>
  <span class="footer-contact">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤: <a href="mailto:contact@enableearth.eco">contact@enableearth.eco</a></span><br>
  <div class="footer-links">
    <a href="https://www.facebook.com/EnableEarthCarbonRemoval/" target="_blank">Facebook</a> | 
    <a href="https://m.me/EnableEarthCarbonRemoval/" target="_blank">Messenger</a>
  </div>
</div>
<!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let currentStep = 1;
// --------- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á marker (map) ---------
let userLocation = { latitude: 19.11, longitude: 99.47 }; // default (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ)
let map, marker, mapReady = false;

function gotoStep(step) {
  event.preventDefault();
  if (step > 1 && !validateStep(currentStep)) return;
  for (let i = 1; i <= 4; i++) {
    document.getElementById('step'+i).classList.remove('active');
  }
  document.getElementById('step'+step).classList.add('active');
  currentStep = step;
  document.getElementById('progress-bar').style.width = (step*25)+'%';
  if(step === 3 && !mapReady) initMap();
  if(step === 3) setTimeout(()=>map.invalidateSize(), 350);
}

function initMap() {
  mapReady = true;
  map = L.map('map').setView([userLocation.latitude, userLocation.longitude], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  marker = L.marker([userLocation.latitude, userLocation.longitude], {draggable:true}).addTo(map);
  marker.on('dragend', function(e){
      let pos = marker.getLatLng();
      userLocation.latitude = pos.lat;
      userLocation.longitude = pos.lng;
      updateLocText(true);
  });
  updateLocText(false);
  document.getElementById('btn-step3-next').disabled = false;
}

function updateLocText(success=true){
  document.getElementById('location-status').innerHTML = success 
    ? '<span style="color:green;font-weight:600;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß!</span>'
    : '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô marker ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
  document.getElementById('location-coord').innerHTML =
    '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: '+userLocation.latitude+'<br>‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: '+userLocation.longitude;
}

// ‡πÉ‡∏ä‡πâ GPS
function setCurrentLocation(e) {
  e.preventDefault();
  const locStatus = document.getElementById('location-status');
  locStatus.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...";
  if (!navigator.geolocation) {
    locStatus.innerHTML = '<span style="color:red;">‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS</span>';
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      userLocation.latitude = pos.coords.latitude;
      userLocation.longitude = pos.coords.longitude;
      marker.setLatLng([userLocation.latitude, userLocation.longitude]);
      map.setView([userLocation.latitude, userLocation.longitude], 16);
      updateLocText(true);
      document.getElementById('btn-step3-next').disabled = false;
    },
    (err) => {
      locStatus.innerHTML = '<span style="color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ('+err.message+')</span>';
    }
  );
}

function validateStep(step) {
  if(step===1) {
    if(!document.getElementById('fullname').value.trim()) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'); return false;
    }
    if(!/^[0-9]{9,10}$/.test(document.getElementById('tel').value.trim())) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return false;
    }
  }
  if(step===2) {
    if(!document.getElementById('farm_area').value.trim()) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏£‡πà'); return false;
    }
    if(!document.getElementById('carbon_credit').value.trim()) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á'); return false;
    }
  }
  if(step===3) {
    if(!userLocation.latitude || !userLocation.longitude) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤'); return false;
    }
  }
  return true;
}

function submitForm(e){
  e.preventDefault();
  if(!validateStep(4)) return;
  // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const data = new FormData();
  // 1. Plot ID = fullname
  data.append('plot_id', document.getElementById('fullname').value.trim());
  // 2. ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô sheet ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ geojson)
  data.append('phone', document.getElementById('tel').value.trim());
  // 3. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏£‡πà (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô geojson ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô sheet ‡πÑ‡∏î‡πâ)
  data.append('farm_area', document.getElementById('farm_area').value.trim());
  // 4. carbon_credit
  data.append('carbon_credit', document.getElementById('carbon_credit').value.trim());
  // 5. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  data.append('farm_detail', document.getElementById('farm_detail').value.trim());
  // 6. lat/lng
  data.append('latitude', userLocation.latitude);
  data.append('longitude', userLocation.longitude);
  // 7. ‡∏†‡∏≤‡∏û
  const imgFile = document.getElementById('image').files[0];
  if(imgFile) data.append('image', imgFile);

  const apiURL = 'https://script.google.com/macros/s/AKfycbwjsnvnfVmURYof6Gb0xJrPxjbwSs6x7jjemDylWxw8J__SxnLale4BODtp0Vt8BNLgsQ/exec'; // ‡πÅ‡∏Å‡πâ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  fetch(apiURL, { method:'POST', body:data })
    .then(r => r.text())
    .then(t => {
      alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£!');
      window.location.reload();
    }).catch(e=>{
      alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà: '+e.message);
    });
}
</script>
</body>
</html>
